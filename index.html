<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps JavaScript API v3 Example: Heatmap Layer</title>
    <link href="map.css" rel="stylesheet">
		<script src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=visualization"></script>
		<script src="http://code.jquery.com/jquery-latest.js"></script>
    <script>
			var map, pointarray, heatmap;

			var lastZoomLevel;
			var lastHeatRadius;



			function getVenueData() {
				var my_url = 'http://' + window.location.host + '/citybeat-backend';
				var crawler_url = my_url + '/get_current_heatmap';

				venue_data = [];

				$.ajax({
					url : crawler_url,
					type : 'GET',
					success : function(data) {
						var venues = $.parseJSON(data);
						for(var i = 0; i < venues.length; i++) {
							var venue = venues[i];
							var lat = venue[0];
							var lon = venue[1];
							var checkins = venue[2];


							if(checkins > 0) {
								var venue_heat = {location: new google.maps.LatLng(lat, lon), weight: checkins};
								venue_data.push(venue_heat);
							}
						}

						heatmap.setData(new google.maps.MVCArray(venue_data));
						console.log(heatmap.getData().getLength());
					},
					error : function() {
						console.log('error getting data');
					}
				});
			}

			function onZoomChange(event) {
				var currZoomLevel = map.getZoom();
				var currHeatRadius = heatmap.radius;

				var maxZoomLevel = 15;
				
				var offset = currHeatRadius * currZoomLevel/maxZoomLevel;

				if(lastZoomLevel > currZoomLevel) {
					offset = lastHeatRadius * lastZoomLevel/maxZoomLevel;
					offset *= -1;
				}
				var newHeatRadius = currHeatRadius + offset;
				if (newHeatRadius < 15) newHeatRadius = 15;
				heatmap.setOptions({radius: newHeatRadius });
				lastZoomLevel = currZoomLevel;
				lastHeatRadius = currHeatRadius;
			}

      function initialize() {

        var mapOptions = {
          zoom: 13,
          center: new google.maps.LatLng(40.740737, -73.959961),
					mapTypeId: google.maps.MapTypeId.ROADMAP,
				};

				lastZoomLevel = 13;

        map = new google.maps.Map(document.getElementById('map_canvas'),
				mapOptions);

				google.maps.event.addListener(map, 'zoom_changed', onZoomChange);

        pointArray = new google.maps.MVCArray();

        heatmap = new google.maps.visualization.HeatmapLayer({
					data: pointArray,
        });

				heatmap.setOptions({radius: 50});

				lastHeatRadius = 50;

				heatmap.setMap(map);
				getVenueData();
      }

      function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
      }

      function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.setOptions({
          gradient: heatmap.get('gradient') ? null : gradient
        });
      }

      function changeOpacity() {
        heatmap.setOptions({opacity: heatmap.get('opacity') ? null : 0.2});
      }
    </script>
  </head>

  <body onload="initialize()">
    <div id="map_canvas" style="height: 95%; width: 100%;"></div>
    <button onclick="toggleHeatmap()">Toggle Heatmap</button>
    <button onclick="changeGradient()">Change gradient</button>
    <button onclick="changeOpacity()">Change opacity</button>
  </body>
</html>

